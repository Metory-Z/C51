/*
*******************************************************************************
*                     1717170017170317171701511717021717(C1717170217)1717
*                    17171717 KST-51 1717021717171717171717 0517170617171717
*
*         (c) 17170717171717 2014 17170006171717171717/17廪171701171717171717 1717171717171717071717
*                 1717001717171717171717171717170817http://www.kingst.org
*
* 17041717171717main.c
* 1717  171717171717101717 171717171717171717171705171717171717171717
* 17汾170017v1.0.0
* 1717  0017171717171717171710171710.11717
*******************************************************************************
*/

#include <reg52.h>

sbit ADDR3 = P1^3;
sbit ENLED = P1^4;
sbit KEY1 = P2^4;
sbit KEY2 = P2^5;
sbit KEY3 = P2^6;
sbit KEY4 = P2^7;

unsigned char code LedChar[] = {  //17171717171717051707170817171717
    0xC0, 0xF9, 0xA4, 0xB0, 0x99, 0x92, 0x82, 0xF8,
    0x80, 0x90, 0x88, 0x83, 0xC6, 0xA1, 0x86, 0x8E
};
unsigned char LedBuff[6] = {  //1717171717171705171717171717
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF
};
unsigned char KeySta[4] = {  //171717171717020800
    1, 1, 1, 1
};

bit StopwatchRunning = 0;  //171717171717б1704
bit StopwatchRefresh = 1;  //171717171717170617±1704
unsigned char DecimalPart = 0;  //1717171717С171717171717
unsigned int  IntegerPart = 0;  //17171717171717171717171717
unsigned char T0RH = 0;  //T01717171705170017170317
unsigned char T0RL = 0;  //T01717171705170717170317

void ConfigTimer0(unsigned int ms);
void StopwatchDisplay();
void KeyDriver();

void main()
{
    EA = 1;      //1717171717ж17
    ENLED = 0;   //0017170517171717171717
    ADDR3 = 1;
    P2 = 0xFE;   //P2.017170171705171717417а1717171717021717171717171717
	ConfigTimer0(2);  //17171717T01717022ms
    
    while (1)
    {
        if (StopwatchRefresh)  //171708061717171717051717021717171717170517171717
        {
            StopwatchRefresh = 0;
            StopwatchDisplay();
        }
        KeyDriver();  //171717081717171717171717171717
    }
}
/* 171717ò1717171717T01717ms-T0171702021717 */
void ConfigTimer0(unsigned int ms)
{
    unsigned long tmp;  //17170217171717
    
    tmp = 11059200 / 12;      //171702171717171717011717
    tmp = (tmp * ms) / 1000;  //17171717171717170417171705
    tmp = 65536 - tmp;        //171717170217171717171705
    tmp = tmp + 18;           //1717171717ж1717170817170217170217171717
    T0RH = (unsigned char)(tmp>>8);  //1717021717171717170517171702171117170317
    T0RL = (unsigned char)tmp;
    TMOD &= 0xF0;   //17171717T01707171717λ
    TMOD |= 0x01;   //17171717T00200041
    TH0 = T0RH;     //17171717T01717171705
    TL0 = T0RL;
    ET0 = 1;        //001717T017ж17
    TR0 = 1;        //17171717T0
}
/* 1717171717171717170517171717 */
void StopwatchDisplay()
{
	signed char i;
	unsigned char buf[4];  //1717171708171717031717171717
    
    //С171717171717081717171717172λ
    LedBuff[0] = LedChar[DecimalPart%10];
    LedBuff[1] = LedChar[DecimalPart/10];
    //1717171717171717081717171717174λ
    buf[0] = IntegerPart%10;
    buf[1] = (IntegerPart/10)%10;
    buf[2] = (IntegerPart/100)%10;
    buf[3] = (IntegerPart/1000)%10;
    for (i=3; i>=1; i--)  //171717171717170817λ17170081717021717170717
    {
        if (buf[i] == 0)
            LedBuff[i+2] = 0xFF;
        else
            break;
    }
    for ( ; i>=0; i--)  //1717Ч17171717λ08171702171705170717
    {
        LedBuff[i+2] = LedChar[buf[i]];
    }
    LedBuff[2] &= 0x7F;  //17171717С17171717
}
/* 17171717170517171717 */
void StopwatchAction()
{
    if (StopwatchRunning)    //17171717171717170509
        StopwatchRunning = 0;
    else                     //δ17171717171717171717
        StopwatchRunning = 1;
}
/* 1717171717λ17171717 */
void StopwatchReset()
{
    StopwatchRunning = 0;  //0509171717
    DecimalPart = 0;       //1717171717171705
    IntegerPart = 0;
    StopwatchRefresh = 1;  //17170617±1704
}
/* 17171717171717171717171717171717801717171717171717171717171717081717171717171717171717171717171707171717е171717 */
void KeyDriver()
{
    unsigned char i;
    static unsigned char backup[4] = {1,1,1,1};

    for (i=0; i<4; i++)  //0717171717174171717171717
    {
        if (backup[i] != KeySta[i])  //171780171717171717
        {
            if (backup[i] != 0)      //1717171717171717020417ж171717
            {
                if (i == 1)          //Esc17171717λ171717
                    StopwatchReset();
                else if (i == 2)     //1711171717171705171717
                    StopwatchAction();
            }
            backup[i] = KeySta[i];   //061717020517ε0317171705
        }
    }
}
/* 171717170917躯1717171717171712170217ж1717е171717 */
void KeyScan()
{
    unsigned char i;
    static unsigned char keybuf[4] = {  //171717170917U17171717
        0xFF, 0xFF, 0xFF, 0xFF
    };
    
    //17171717051717171317171717
    keybuf[0] = (keybuf[0] << 1) | KEY1;
    keybuf[1] = (keybuf[1] << 1) | KEY2;
    keybuf[2] = (keybuf[2] << 1) | KEY3;
    keybuf[3] = (keybuf[3] << 1) | KEY4;
    //1717171717171717°1717170800
    for (i=0; i<4; i++)
    {
        if (keybuf[i] == 0x00)
        {   //1717171781717091717050201717171716ms1712171702171717080002171717171717021717171717171701171702171717
            KeySta[i] = 0;
        }
        else if (keybuf[i] == 0xFF)
        {   //1717171781717091717050211717171716ms1712171707171717080002171717171717021717171717171701171707171717
            KeySta[i] = 1;
        }
    }
}
/* 17171717101700091717061702171717171717171712170217ж1717е171717 */
void LedScan()
{
    static unsigned char i = 0;  //17170009171717171717
    
    P0 = 0xFF;             //171917171717ж1705λ171717170517171717
    P1 = (P1 & 0xF8) | i;  //λ0517171717051717051717P11711173λ
    P0 = LedBuff[i];       //171717171717171717171717λ17011717171717170317P01717
    if (i < 5)             //171717171717171707171717171717171717171717171717171717
        i++;
    else
        i = 0;
}
/* 1717171717171717171717171707171710ms171717170517ν17171717171717171717171217 */
void StopwatchCount()
{
    if (StopwatchRunning)  //17171717171717171717080002171717171717171705
    {
        DecimalPart++;           //С171717171717+1
        if (DecimalPart >= 100)  //С1717171717020117100021717λ17171717171717171717
        {
            DecimalPart = 0;
            IntegerPart++;       //1717171717171717+1
            if (IntegerPart >= 10000)  //17171717171717020117100000217171717
            {
                IntegerPart = 0;
            }
        }
        StopwatchRefresh = 1;    //17171717171717171717170617±1704
    }
}
/* T017ж051717171717171717171717171717191717171717091717171717171717171717 */
void InterruptTimer0() interrupt 1
{
    static unsigned char tmr10ms = 0;

    TH0 = T0RH;  //171717041717171717171705
    TL0 = T0RL;
    LedScan();   //1717171717091717171705
    KeyScan();   //17171717091717
    //17170210ms1717171705171717171717171717
    tmr10ms++;
    if (tmr10ms >= 5)
    {
        tmr10ms = 0;
        StopwatchCount();  //171717171717171717171717171717
    }
}
